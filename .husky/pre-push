#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-push validation..."

# Validate command patterns (fast - catches deprecated patterns)
if node -e "const pkg=require('./package.json');process.exit(pkg.scripts['test:patterns']?0:1)" 2>/dev/null; then
  echo "ğŸ” Validating command patterns..."
  npm run test:patterns || {
    echo "âŒ Pattern validation failed! Deprecated patterns detected."
    exit 1
  }
fi

# Run lint (catches errors before CI)
echo "ğŸ“ Linting..."
npm run lint || {
  echo "âŒ Lint failed! Fix errors before pushing."
  exit 1
}

# Run format check (ensures code style consistency)
echo "âœ¨ Checking formatting..."
npm run format:check || {
  echo "âŒ Format check failed! Run 'npm run format' to fix."
  exit 1
}

# Test command execution (CRITICAL - prevents command generation bugs)
if node -e "const pkg=require('./package.json');process.exit(pkg.scripts['test:commands']?0:1)" 2>/dev/null; then
  echo "ğŸ§ª Testing command execution..."
  npm run test:commands || {
    echo "âŒ Command execution tests failed! Generated commands are broken."
    exit 1
  }
fi

# Run tests if they exist
if node -e "const pkg=require('./package.json');process.exit(pkg.scripts.test?0:1)" 2>/dev/null; then
  echo "ğŸ§ª Running unit tests..."
  npm test || {
    echo "âŒ Tests failed! Fix failing tests before pushing."
    exit 1
  }
fi

echo "âœ… Pre-push validation passed!"
